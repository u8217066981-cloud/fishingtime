<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viber –ì—Ä–∞—Ñ–∏–∫ - Final</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; background: #f4f6f8; padding: 20px; color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #665cac; padding-bottom: 10px; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 24px; }
        .settings-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; transition: all 0.3s; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        .needs-config { animation: pulse-red 1.5s infinite; color: red; border: 1px solid red; }
        #settingsPanel { display: none; background: #333; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        #settingsPanel input { width: 100%; padding: 8px; margin-top: 5px; background: #555; color: white; border: 1px solid #777; box-sizing: border-box; }
        #appVersionDisplay { margin-top: 10px; font-size: 0.9em; padding-top: 5px; border-top: 1px solid #555;}
        #settingsPanel button { width: 100%; padding: 10px; margin-top: 10px; background: #665cac; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        label { display: block; font-weight: bold; margin-top: 15px; margin-bottom: 5px; color: #555; }
        select, input[type="datetime-local"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; box-sizing: border-box; border-radius: 6px; font-size: 15px; }
        
        /* –û–±—â–∏ –ò–∫–æ–Ω–∏ */
        .fixed-icon-bar { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; padding: 10px 0; border-bottom: 1px dashed #ddd; }
        .fixed-icon-btn { font-size: 20px; cursor: pointer; padding: 5px; border-radius: 4px; transition: transform 0.1s; }
        .fixed-icon-btn:hover { transform: scale(1.2); }

        /* –ü—Ä–æ–¥—É–∫—Ç–æ–≤ –ë–∞—Ä */
        #productBar { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 5px; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .product-btn { 
            cursor: pointer; text-align: center; padding: 8px 5px; border-radius: 6px; 
            background: white; border: 1px solid #ddd; user-select: none; font-size: 14px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            line-height: 1.2; transition: transform 0.1s;
        }
        .product-btn:hover { transform: scale(1.05); background: #eef; }
        .product-icon { font-size: 20px; margin-bottom: 2px; }

        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; } 
        .btn-primary { flex: 1 1 100%; background: #000; color: white; border: none; font-size: 16px; font-weight: bold; padding: 15px; border-radius: 6px; cursor: pointer; order: 3;} 
        .btn-instant { flex: 1 1 100%; background: #e74c3c; color: white; border: none; font-size: 16px; font-weight: bold; padding: 15px; border-radius: 6px; cursor: pointer; order: 2; margin-top: 10px;} 
        .btn-magic { flex: 1 1 100%; background: #665cac; color: white; border: none; font-size: 16px; font-weight: bold; padding: 15px; border-radius: 6px; cursor: pointer; order: 1;} 
        .btn-magic:hover { background: #50468c; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 14px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #e9ecef; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .delete-btn:hover { background: #c0392b; }
        .status-WAIT { color: #f39c12; background: #fff3cd; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .status-DONE { color: #27ae60; background: #d4edda; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .status-ERR { color: #c0392b; background: #f8d7da; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .status-EXPIRED { color: #8e44ad; background: #e0bfe7; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .time-col { width: 130px; }
        .refresh-text { font-size: 0.8em; color: #555; margin-left: 10px; }
        
        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏ */
        .product-management { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        
        .view-msg-btn { background: none; border: none; cursor: pointer; font-size: 16px; margin-left: 5px; padding: 0; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üìÖ Viber –î–∏—Å–ø–µ—á–µ—Ä</h1>
        <button id="settingsBtn" class="settings-btn" onclick="toggleSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
    </div>

    <div id="settingsPanel">
        <label style="color:white; margin-top:0;">üîó Google Script URL:</label>
        <input type="text" id="apiUrlInput" placeholder="–ü–æ—Å—Ç–∞–≤–µ—Ç–µ URL-–∞ –æ—Ç Deploy —Ç—É–∫..."> 
        <small style="color:#ccc;">–¢–æ–∑–∏ –∞–¥—Ä–µ—Å —Å–µ –∑–∞–ø–∞–∑–≤–∞ –∏ –∫–∞—Ç–æ backup –≤ Sheet-–∞.</small>
        <button onclick="saveUrl()">–ó–ê–ü–ê–ó–ò –õ–ò–ù–ö–ê</button>
        <div id="appVersionDisplay" style="margin-top: 10px; font-size: 0.9em;"></div> 
    </div>

    <div class="card">
        <label>1. –ò–∑–±–µ—Ä–∏ –õ–∏–Ω–∏—è</label>
        <select id="line">
            <option value="–õ–∏–Ω–∏—è 1">–õ–∏–Ω–∏—è 1</option>
            <option value="–õ–∏–Ω–∏—è 2">–õ–∏–Ω–∏—è 2</option>
            <option value="VIP">VIP –ì—Ä—É–ø–∞</option>
        </select>

        <label>2. –ö–æ–≥–∞ –¥–∞ —Å–µ –ø—Ä–∞—Ç–∏?</label>
        <input type="datetime-local" id="scheduledTime">
        
        <label>3. –û–±—â–∏ –∏–∫–æ–Ω–∏</label>
        <div class="fixed-icon-bar">
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üáßüá¨')">üáßüá¨</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üá¨üá∑')">üá¨üá∑</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üìû')">üìû</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üöö')">üöö</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üî¥')">üî¥</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('‚úÖ')">‚úÖ</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('‚ùÑÔ∏è')">‚ùÑÔ∏è</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üßä')">üßä</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üåä')">üåä</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üé£')">üé£</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üêü')">üêü</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üê†')">üê†</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('ü¶à')">ü¶à</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('ü¶û')">ü¶û</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('ü¶ê')">ü¶ê</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üêô')">üêô</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üêö')">üêö</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üç£')">üç£</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üç±')">üç±</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üç§')">üç§</span>
            <span class="fixed-icon-btn" onclick="addGeneralIcon('üî™')">üî™</span>
        </div>

        <label>4. –í–∏–¥–æ–≤–µ —Ä–∏–±–∞ (–ö–ª–∏–∫–Ω–∏ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ —Å —Ü–µ–Ω–∞)</label>
        <div id="productBar">
            <div style="text-align: center; color: #777;">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏...</div>
        </div>
        
        <label>5. –°—ä–æ–±—â–µ–Ω–∏–µ / –ü—Ä–æ–¥—É–∫—Ç–∏</label>
        <textarea id="message" rows="6" placeholder="–ù–∞–ø–∏—à–∏ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ —Ç—É–∫..."></textarea>

        <div class="btn-group">
            <button class="btn-magic" onclick="formatWithAI()">‚ú® –û—Ñ–æ—Ä–º–∏ —Å AI</button> 
            <button class="btn-instant" onclick="sendInstantly()">‚ö° –ò–∑–ø—Ä–∞—Ç–∏ —Å–µ–≥–∞</button>
            <button class="btn-primary" onclick="addToQueue()">–î–û–ë–ê–í–ò –í –ì–†–ê–§–ò–ö–ê üöÄ</button>
        </div>
        
        <div id="status" style="margin-top: 15px; text-align: center; font-weight: bold;"></div>
        
        </div>

    <h2 style="margin-top: 40px; border-bottom: 2px solid #ccc;">üìã –¢–µ–∫—É—â –ì—Ä–∞—Ñ–∏–∫</h2>

    <div id="filterControls">
        <div>
            <label style="font-size: 0.9em; font-weight: bold;">–§–∏–ª—Ç—ä—Ä –ø–æ –õ–∏–Ω–∏—è:</label>
            <select id="lineFilter" onchange="applyFilters()">
                <option value="ALL">–í—Å–∏—á–∫–∏ –õ–∏–Ω–∏–∏</option>
                <option value="–õ–∏–Ω–∏—è 1">–õ–∏–Ω–∏—è 1</option>
                <option value="–õ–∏–Ω–∏—è 2">–õ–∏–Ω–∏—è 2</option>
                <option value="VIP">VIP –ì—Ä—É–ø–∞</option>
            </select>
        </div>
        <div>
            <label style="font-size: 0.9em; font-weight: bold;">–§–∏–ª—Ç—ä—Ä –ø–æ –°—Ç–∞—Ç—É—Å:</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="ALL">–í—Å–∏—á–∫–∏ –°—Ç–∞—Ç—É—Å–∏</option>
                <option value="–ß–ê–ö–ê">–ß–ê–ö–ê</option>
                <option value="–ò–ó–ü–™–õ–ù–ï–ù–û">–ò–ó–ü–™–õ–ù–ï–ù–û</option>
                <option value="–ì–†–ï–®–ö–ê">–ì–†–ï–®–ö–ê</option>
                <option value="–ò–ó–¢–ï–ö–™–õ">–ò–ó–¢–ï–ö–™–õ</option>
            </select>
        </div>
        <button onclick="applyFilters()" style="background: #ccc; padding: 8px 12px; font-size: 14px; margin-top: 18px; height: 38px;">üîÑ –û–±–Ω–æ–≤–∏</button>
        <span id="lastRefreshTime" class="refresh-text">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –≤—Å–µ–∫–∏ 60 —Å–µ–∫—É–Ω–¥–∏.</span>
    </div>

    <table>
        <thead>
            <tr><th class="time-col">–ß–∞—Å (–ü–ª–∞–Ω)</th><th class="time-col">–ò–∑–ø—Ä–∞—Ç–µ–Ω–æ –≤</th><th>–õ–∏–Ω–∏—è</th><th>–°—ä–æ–±—â–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ò–∑—Ç—Ä–∏–π</th></tr>
        </thead>
        <tbody id="scheduleTable">
            <tr><td colspan='6'>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
        </tbody>
    </table>
    <button id="loadMoreBtn" onclick="loadMore()" style="display:none; width: 100%; padding: 10px; background: #665cac; color: white; border: none; border-radius: 6px; margin-top: 15px; font-size: 16px; font-weight: bold;">–ó–∞—Ä–µ–¥–∏ –æ—â–µ...</button>


<script>
    const APP_VERSION = "1.8.0 (Final Product UI)";
    
    let currentOffset = 0;
    const FETCH_LIMIT = 20;
    
    const loadedMessages = {}; 

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê –õ–ò–ù–ö–ê ---
    function toggleSettings() {
        const panel = document.getElementById('settingsPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function checkUrlStatus() {
        const url = localStorage.getItem('viberApiUrl');
        const btn = document.getElementById('settingsBtn');
        const panel = document.getElementById('settingsPanel');

        if (!url) {
            btn.classList.add('needs-config');
            panel.style.display = 'block';
            return null;
        } else {
            btn.classList.remove('needs-config');
            panel.style.display = 'none';
            return url;
        }
    }

    async function saveUrl() {
        const url = document.getElementById('apiUrlInput').value.trim();
        if (!url) {
            alert("–ú–æ–ª—è, –ø–æ—Å—Ç–∞–≤–µ—Ç–µ –ª–∏–Ω–∫–∞!");
            return;
        }

        try {
            localStorage.setItem('viberApiUrl', url);
            
            await fetch(url, {
                method: 'POST',
                body: JSON.stringify({ action: 'save_url', newUrl: url }) 
            });

            alert("‚úÖ –õ–∏–Ω–∫—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω —É—Å–ø–µ—à–Ω–æ –≤ –±—Ä–∞—É–∑—ä—Ä–∞ –∏ –∫–∞—Ç–æ backup!");
            checkUrlStatus();
            applyFilters(); 
            loadProducts(); 

        } catch (e) {
             alert("‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–ø–∏—Ç –∑–∞ –∑–∞–ø–∏—Å –≤ Sheet. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ –ª–∏–Ω–∫—ä—Ç –µ –≤–µ—Ä–µ–Ω –∏ Deploy –µ OK.");
             checkUrlStatus(); 
        }
    }
    
    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê –ü–†–û–î–£–ö–¢–ò (–õ–û–ì–ò–ö–ê) ---
    function addGeneralIcon(icon) {
        const textArea = document.getElementById('message');
        textArea.value += icon;
        textArea.focus();
    }

    async function loadProducts() {
        const url = checkUrlStatus();
        const productBar = document.getElementById('productBar');
        productBar.innerHTML = '<div style="text-align: center; color: #777;">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>';
        if (!url) return; 

        try {
            const response = await fetch(url + '?action=get_products');
            const products = await response.json();
            
            if (products.error || products.length === 0) {
                productBar.innerHTML = '<div style="color: orange;">–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏.</div>';
                return;
            }

            productBar.innerHTML = ''; 
            products.forEach(p => {
                productBar.innerHTML += `
                    <div class="product-btn" onclick="addProductToMessage('${p.name}', '${p.icon}')">
                        <span class="product-icon">${p.icon}</span>
                        <span>${p.name}</span>
                    </div>
                `;
            });

        } catch (e) {
            productBar.innerHTML = `<div style="color: red;">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ: ${e.message}</div>`;
        }
    }

    function addProductToMessage(productName, icon) {
        const price = prompt(`–í—ä–≤–µ–¥–∏ —Ü–µ–Ω–∞ –∑–∞ ${productName}:`);
        
        if (price === null || price.trim() === '') {
            return; 
        }

        const formattedPrice = price.replace(/,/g, '.').trim();
        const textArea = document.getElementById('message');
        
        textArea.value += `${icon} ${productName} - ${formattedPrice} –ª–≤.\n`;
        textArea.focus();
    }
    
    function loadMessageToEditor(rowIndex) {
        const message = loadedMessages[rowIndex];
        if (message) {
            document.getElementById('message').value = message;
            document.getElementById('status').innerText = `üìù –°—ä–æ–±—â–µ–Ω–∏–µ –æ—Ç —Ä–µ–¥ ${rowIndex} –µ –∑–∞—Ä–µ–¥–µ–Ω–æ –∑–∞ —Ä–µ–¥–∞–∫—Ü–∏—è/–ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ.`;
            document.getElementById('status').style.color = 'darkgreen';
        } else {
            document.getElementById('status').innerText = '–ì—Ä–µ—à–∫–∞: –ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –∑–∞—Ä–µ–¥–∏ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ.';
            document.getElementById('status').style.color = 'red';
        }
    }
    
    function formatWithAI() {
        const textArea = document.getElementById('message');
        let text = textArea.value.trim();
        if (!text) { alert("–ü—ä—Ä–≤–æ –Ω–∞–ø–∏—à–∏ –Ω—è–∫–∞–∫–≤–∏ –ø—Ä–æ–¥—É–∫—Ç–∏!"); return; }
        
        let items = text.split(/\n/); 
        let formattedMsg = "üëã –ó–¥—Ä–∞–≤–µ–π—Ç–µ! –î–Ω–µ—Å —Å–º–µ –≤–∏ –ø—Ä–∏–≥–æ—Ç–≤–∏–ª–∏ –ø—Ä–µ—Å–Ω–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:\n\n";
        
        const emojiMap = {
            "—Ö–∞–º—Å–∏—è": "üêü", "—Ü–∞—Ü–∞": "üêü", "—Å–∫—É–º—Ä–∏—è": "üêü", "–ª–∞–≤—Ä–∞–∫": "üåä", "—Ü–∏–ø—É—Ä–∞": "üåä", 
            "–ª–µ—Ñ–µ—Ä": "üåä", "–∞–∫—É–ª–∞": "ü¶à", "–≤–µ—è–Ω–æ": "ü¶à", "—Å–∫–∞—Ä–∏–¥–∏": "ü¶ê", "—Ä–∞–∫": "ü¶û", 
            "–æ–º–∞—Ä": "ü¶û", "–º–∏–¥–∏": "üêö", "—Ö–∞–π–≤–µ—Ä": "üî¥", "—Å–∞—Ñ—Ä–∏–¥": "üé£", "—á–µ—Ä–Ω–æ–∫–æ–ø": "üé£", 
            "—Å—å–æ–º–≥–∞": "üç£", "—Ñ–∏–ª–µ": "üî™", "–∑–∞–º—Ä–∞–∑–µ": "‚ùÑÔ∏è", "–ª–µ–¥": "üßä", 
            "–±—ä–ª–≥–∞—Ä—Å–∫–æ": "üáßüá¨", "–≥—Ä—ä—Ü–∫–æ": "üá¨üá∑"
        };
        
        items.forEach(item => {
            item = item.trim();
            if (item.length > 0) {
                let lowerItem = item.toLowerCase();
                
                const startsWithIcon = item.match(/^\p{Emoji_Presentation}/u) || item.match(/^\p{Emoji}/u);
                
                if (startsWithIcon) {
                    formattedMsg += `${item}\n`;
                    return; 
                }

                let icon = "üêü"; 
                for (let key in emojiMap) {
                    if (lowerItem.includes(key)) { 
                        icon = emojiMap[key]; 
                        break; 
                    }
                }
                
                item = item.charAt(0).toUpperCase() + item.slice(1);
                formattedMsg += `${icon} ${item}\n`;
            }
        });
        
        formattedMsg += "\nüìû –ü–æ—Ä—ä—á–∞–π—Ç–µ —Ç—É–∫ –∏–ª–∏ –Ω–∞ —Ç–µ–ª: 088884884 –°–ï–ì–ê!";
        textArea.value = formattedMsg;
    }

    // --- –§–£–ù–ö–¶–ò–ò –ó–ê –ì–†–ê–§–ò–ö ---
    function sendInstantly() {
        const msg = document.getElementById('message').value;
        if (!msg) { alert("–ú–æ–ª—è, –Ω–∞–ø–∏—à–µ—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ!"); return; }
        if (!confirm("‚ö†Ô∏è –ü–û–¢–í–™–†–ñ–î–ï–ù–ò–ï: –°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑–ø—Ä–∞—Ç–∏—Ç–µ —Ç–æ–≤–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ –ú–û–ú–ï–ù–¢–ê–õ–ù–û? (–©–µ –±—ä–¥–µ –Ω–∞—Å—Ä–æ—á–µ–Ω–æ –∑–∞ 2 –º–∏–Ω—É—Ç–∏ –Ω–∞–ø—Ä–µ–¥ –∏ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ –ø—Ä–∏ —Å–ª–µ–¥–≤–∞—â–∏—è —Ü–∏–∫—ä–ª –Ω–∞ —Ç–∞–π–º–µ—Ä–∞.)")) { return; }

        const now = new Date();
        const twoMinutesLater = new Date(now.getTime() + 120000); 
        const timeString = twoMinutesLater.toISOString().substring(0, 16);
        addToQueue(timeString);
    }
    
    async function addToQueue(timeOverride) {
        const url = checkUrlStatus();
        if (!url) return; 

        const line = document.getElementById('line').value;
        const time = timeOverride || document.getElementById('scheduledTime').value; 
        const msg = document.getElementById('message').value;
        const statusDiv = document.getElementById('status');
        const btnPrimary = document.querySelector('.btn-primary');
        const btnInstant = document.querySelector('.btn-instant'); 

        if(!msg || !time) { alert("–ò–∑–±–µ—Ä–∏ —á–∞—Å –∏ –Ω–∞–ø–∏—à–∏ —Å—ä–æ–±—â–µ–Ω–∏–µ!"); return; }

        const scheduledDate = new Date(time);
        const now = new Date();
        let initialStatus = "–ß–ê–ö–ê";
        
        if (scheduledDate < now) {
            initialStatus = "–ò–ó–¢–ï–ö–™–õ"; 
            if (!timeOverride && !confirm(`–í–Ω–∏–º–∞–Ω–∏–µ! –ß–∞—Å—ä—Ç (${scheduledDate.toLocaleString('bg-BG')}) –µ –≤ –º–∏–Ω–∞–ª–æ—Ç–æ. –°—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ —â–µ –±—ä–¥–µ –º–∞—Ä–∫–∏—Ä–∞–Ω–æ –∫–∞—Ç–æ '–ò–ó–¢–ï–ö–™–õ' –∏ –ù–Ø–ú–ê –¥–∞ —Å–µ –∏–∑–ø—Ä–∞—Ç–∏. –ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ?`)) { return; }
        }

        statusDiv.innerText = "‚è≥ –ó–∞–ø–∏—Å–≤–∞–Ω–µ...";
        statusDiv.style.color = "blue";
        btnPrimary.disabled = true;
        btnInstant.disabled = true; 
        
        try {
            await fetch(url, {
                method: 'POST',
                body: JSON.stringify({ action: 'add', line: line, scheduledTime: time, message: msg, initialStatus: initialStatus }) 
            });
            
            statusDiv.innerText = timeOverride ? `‚úÖ –£–°–ü–ï–®–ù–û –ù–ê–°–†–û–ß–ï–ù–û! –ó–∞ ${new Date(time).toLocaleTimeString('bg-BG')}` : `‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–µ–Ω–æ –≤ –≥—Ä–∞—Ñ–∏–∫–∞! –°—Ç–∞—Ç—É—Å: ${initialStatus}`;
            statusDiv.style.color = "green";
            document.getElementById('message').value = "";
            if (timeOverride) { document.getElementById('scheduledTime').value = ''; }
            applyFilters(); 

        } catch (e) {
            statusDiv.innerText = "‚ùå –ì—Ä–µ—à–∫–∞: " + e.message;
            statusDiv.style.color = "red";
        } finally {
            btnPrimary.disabled = false;
            btnInstant.disabled = false;
        }
    }


    async function deleteScheduledMessage(rowIndex) {
        if (!confirm("–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–∑–∏ —Ä–µ–¥?")) return;
        const url = checkUrlStatus();
        if (!url) return;

        const statusDiv = document.getElementById('status');
        statusDiv.innerText = "‚è≥ –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–¥ " + rowIndex + "...";
        statusDiv.style.color = "orange";

        try {
            const response = await fetch(url, { method: 'POST', body: JSON.stringify({ action: 'delete', rowIndex: rowIndex }) });
            const result = await response.json();
            if (result.status === "success") {
                statusDiv.innerText = "‚úÖ –†–µ–¥—ä—Ç –µ —É—Å–ø–µ—à–Ω–æ –∏–∑—Ç—Ä–∏—Ç!";
                statusDiv.style.color = "green";
                applyFilters(); 
            } else {
                throw new Error(result.message);
            }
        } catch (e) {
            statusDiv.innerText = "‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—Ä–∏–µ–Ω–µ: " + e.message;
            statusDiv.style.color = "red";
        }
    }
    
    function loadMore() { currentOffset += FETCH_LIMIT; loadSchedule(true); }
    function applyFilters() { currentOffset = 0; const tbody = document.getElementById('scheduleTable'); if (tbody.children.length > 0) { tbody.innerHTML = "<tr><td colspan='6'>–û–±–Ω–æ–≤—è–≤–∞–Ω–µ...</td></tr>"; } document.getElementById('loadMoreBtn').style.display = 'none'; loadSchedule(false); }

    async function loadSchedule(isAppend = false) {
        const url = localStorage.getItem('viberApiUrl');
        const tbody = document.getElementById('scheduleTable');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const lastRefreshTime = document.getElementById('lastRefreshTime');
        
        if (!url) { tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>–í—ä–≤–µ–¥–µ—Ç–µ –ª–∏–Ω–∫–∞ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ (‚öôÔ∏è)</td></tr>"; return; }

        try {
            const line = document.getElementById('lineFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            let queryString = `?action=get_schedule&line=${line}&status=${status}&limit=${FETCH_LIMIT}&offset=${currentOffset}`;
            
            const response = await fetch(url + queryString);
            
            const resultData = await response.json(); 
            const data = resultData.rows;
            const totalCount = resultData.totalCount;
            
            if (!isAppend) { 
                tbody.innerHTML = ""; 
                Object.keys(loadedMessages).forEach(key => delete loadedMessages[key]);
            }
            
            if (data.length === 0 && !isAppend) { tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>–ù—è–º–∞ –∑–∞–ø–∏—Å–∏, –æ—Ç–≥–æ–≤–∞—Ä—è—â–∏ –Ω–∞ —Ñ–∏–ª—Ç—ä—Ä–∞.</td></tr>"; return; }
            if (data.length === 0 && isAppend) { loadMoreBtn.style.display = 'none'; return; }

            
            data.forEach(row => {
                loadedMessages[row.rowNumber] = row.message;

                let date = new Date(row.scheduled).toLocaleString('bg-BG');
                let statusClass = row.status === "–ß–ê–ö–ê" ? "status-WAIT" : 
                                  row.status === "–ò–ó–ü–™–õ–ù–ï–ù–û" ? "status-DONE" : 
                                  row.status === "–ò–ó–¢–ï–ö–™–õ" ? "status-EXPIRED" : "status-ERR";
                
                const actualTime = row.status === "–ò–ó–ü–™–õ–ù–ï–ù–û" && row.actualSendTime ? new Date(row.actualSendTime).toLocaleTimeString('bg-BG') : '-';

                const loadMessageIcon = row.status === "–ò–ó–ü–™–õ–ù–ï–ù–û" ? 
                    `<button class="view-msg-btn" onclick="loadMessageToEditor(${row.rowNumber})" title="–ó–∞—Ä–µ–¥–∏ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –∑–∞ —Ä–µ–¥–∞–∫—Ü–∏—è/–ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ">üìù</button>` : '';

                const deleteButton = `<button class="delete-btn" onclick="deleteScheduledMessage(${row.rowNumber})">üóëÔ∏è</button>`;
                
                tbody.innerHTML += `
                    <tr>
                        <td class="time-col">${date}</td>
                        <td class="time-col">${actualTime}</td>
                        <td>${row.line}</td>
                        <td>${row.message.substring(0, 30)}... ${loadMessageIcon}</td>
                        <td><span class="${statusClass}">${row.status}</span></td>
                        <td>${deleteButton}</td>
                    </tr>
                `;
            });

            if ((currentOffset + data.length) < totalCount) {
                const remaining = totalCount - (currentOffset + data.length);
                loadMoreBtn.innerText = `–ó–∞—Ä–µ–¥–∏ –æ—â–µ (${remaining} –æ—Å—Ç–∞–≤–∞—â–∏)`;
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
            
            lastRefreshTime.innerText = `–û–±–Ω–æ–≤–µ–Ω–æ: ${new Date().toLocaleTimeString('bg-BG')}. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞ –≤—Å–µ–∫–∏ 60 —Å–µ–∫—É–Ω–¥–∏.`;


        } catch (e) { tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –ª–∏–Ω–∫–∞! –ì—Ä–µ—à–∫–∞: " + e.message + "</td></tr>"; }
    }
    
    window.onload = function() {
        document.getElementById('appVersionDisplay').innerHTML = `–í–µ—Ä—Å–∏—è –Ω–∞ —Ç–∞–±–ª–æ—Ç–æ: <b>${APP_VERSION}</b>`;
        const savedUrl = localStorage.getItem('viberApiUrl');
        if (savedUrl) { document.getElementById('apiUrlInput').value = savedUrl; }
        
        checkUrlStatus();
        applyFilters(); 
        loadProducts(); 

        setInterval(applyFilters, 60000);
    }
</script>
</body>
</html>